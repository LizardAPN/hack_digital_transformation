# Скрипты инициализации базы данных

Эта директория содержит SQL скрипты, которые автоматически выполняются при первом запуске контейнера базы данных для инициализации структуры базы данных приложения.

## Назначение

Скрипты в этой директории служат для:

1. **Создания таблиц** - Инициализация структуры базы данных с необходимыми таблицами
2. **Создания индексов** - Оптимизация запросов к базе данных
3. **Настройки триггеров** - Автоматическое обновление временных меток
4. **Начального заполнения** - Добавление начальных данных (при необходимости)

## Порядок выполнения

Скрипты выполняются в алфавитном порядке по имени файла. Используйте числовые префиксы для контроля порядка выполнения:

- `01_*.sql` - Создание таблиц
- `02_*.sql` - Создание индексов
- `03_*.sql` - Настройка триггеров
- `04_*.sql` - Начальное заполнение данными
- `99_*.sql` - Финальные настройки

## Доступные скрипты

### 01_init_tables.sql

Создает основные таблицы приложения:

- `users` - Таблица пользователей
- `user_photos` - Таблица загруженных фотографий
- `processing_results` - Таблица результатов обработки изображений

Также создает:
- Индексы для оптимизации запросов
- Функции для автоматического обновления временных меток
- Триггеры для поддержания целостности данных

## Структура скрипта

Каждый SQL скрипт следует структуре, описанной в `src/sql_scripts/README.md`:

```sql
-- =============================================
-- Скрипт: [Краткое описание того, что делает скрипт]
-- Автор: [Имя автора]
-- Дата: [Дата создания/модификации]
-- =============================================

/* 
Описание:
[Краткое описание назначения скрипта]

Входные данные:
[Список входных таблиц или источников данных]

Выходные данные:
[Список выходных таблиц или результирующих наборов]

Зависимости:
[Список зависимостей или допущений]
*/

-- Установка параметров сессии (если необходимо)
SET statement_timeout = 0;

-- Основная логика запроса
[SQL код здесь]

-- Пример использования (если применимо)
/*
SELECT * FROM output_table LIMIT 10;
*/
```

## Добавление новых скриптов

При добавлении новых скриптов соблюдайте следующие правила:

1. **Соглашение об именовании**: Используйте префикс с номером порядка выполнения
   - ✅ `02_create_indexes.sql`
   - ✅ `03_setup_triggers.sql`
   - ❌ `indexes.sql`

2. **Документация**: Включайте заголовочный комментарий с объяснением назначения скрипта

3. **Идемпотентность**: Делайте скрипты идемпотентными (безопасны для многократного выполнения)
   ```sql
   CREATE TABLE IF NOT EXISTS table_name (...);
   CREATE INDEX IF NOT EXISTS index_name ON table_name (...);
   ```

4. **Обработка ошибок**: Используйте транзакции для многошаговых операций

## Тестирование скриптов

Для тестирования скриптов локально можно использовать следующую команду:

```bash
# Подключение к локальной базе данных
psql -h localhost -p 5432 -U postgres -d building_detector -f 01_init_tables.sql
```

## Особенности Docker

При использовании с Docker контейнером PostgreSQL:

1. Скрипты автоматически выполняются при первом запуске контейнера
2. Скрипты выполняются в алфавитном порядке
3. Каждый скрипт выполняется только один раз (отслеживается внутренним механизмом Docker)
4. Для повторного выполнения скриптов необходимо удалить том данных контейнера

## Решение проблем

### Скрипты не выполняются

Убедитесь, что:
1. Скрипты имеют правильные права доступа (chmod +r)
2. Имена файлов соответствуют шаблону *.sql
3. Контейнер запускается впервые или том данных был удален

### Ошибки выполнения

Проверьте логи контейнера базы данных:
```bash
docker logs [имя_контейнера_бд]
```

Общие причины ошибок:
1. Синтаксические ошибки в SQL
2. Нарушение порядка зависимостей
3. Проблемы с правами доступа
