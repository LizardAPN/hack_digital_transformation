# Приложение для определения координат по фотографиям зданий

## Описание проекта

Это полноценное приложение позволяет пользователям загружать фотографии зданий и автоматически получать их географические координаты и адрес. Приложение использует компьютерное зрение для анализа изображений и определения местоположения зданий на основе визуального поиска по базе данных.

## Архитектура проекта

Приложение состоит из нескольких микросервисов:

1. **Nginx** - веб-сервер и маршрутизатор запросов
2. **Auth Service** - сервис аутентификации пользователей
3. **Photo Upload Service** - сервис загрузки фотографий
4. **Main Application Service** - основной сервис обработки изображений
5. **Database** - база данных PostgreSQL
6. **Redis** - хранилище для очередей задач и кэширования

### Основные компоненты

- **Frontend** - веб-интерфейс на HTML/CSS/JavaScript
- **Computer Vision Model** - модель компьютерного зрения на основе ResNet50
- **FAISS Index** - индекс для быстрого поиска похожих изображений
- **Geocoder** - сервис геокодирования для получения адресов по координатам
- **OCR** - оптический распознаватель текста для извлечения информации с изображений
- **Celery** - система для асинхронной обработки задач

## Установка и запуск

### Требования

- Docker и Docker Compose
- Аккаунт в облачном хранилище (например, Yandex Object Storage)
- API ключи для геокодеров (Yandex, Google, OpenStreetMap)

### Настройка переменных окружения

Создайте файл `.env` в корне проекта на основе `.env.example`:

```bash
# AWS S3 Credentials
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_ENDPOINT_URL=https://storage.yandexcloud.net
AWS_BUCKET_NAME=your_bucket_name

# Database
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=building_detector

# Geocoders
YANDEX_GEOCODER_API_KEY=your_yandex_api_key
GOOGLE_GEOCODER_API_KEY=your_google_api_key

# Celery
CELERY_WORKER_CONCURRENCY=4
REDIS_URL=redis://localhost:6379/0
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/building_detector
```

### Запуск приложения

1. Перейдите в директорию `full-stack`:
   ```bash
   cd full-stack
   ```

2. Запустите приложение с помощью Docker Compose:
   ```bash
   docker-compose up -d
   ```

3. Приложение будет доступно по адресу: http://localhost

### Инициализация базы данных

При первом запуске база данных будет автоматически инициализирована с необходимыми таблицами с помощью скриптов инициализации, расположенных в `full-stack/DB/init/`:

- `users` - таблица пользователей
- `user_photos` - таблица загруженных фотографий
- `processing_results` - таблица результатов обработки изображений

Скрипты инициализации включают:
- Создание таблиц с необходимыми индексами
- Настройку триггеров для автоматического обновления временных меток
- Оптимизацию структуры базы данных для эффективной работы приложения

## Использование приложения

### Регистрация и вход

1. Откройте приложение в браузере
2. Нажмите кнопку "Register" для регистрации нового пользователя
3. После регистрации войдите в систему, используя свои учетные данные

### Загрузка фотографий

1. После входа вы попадете на страницу Workbench
2. Нажмите кнопку "Upload Photo" или кликните на карточку "+ Add Photo"
3. Выберите фотографию здания для загрузки
4. Фотография будет автоматически загружена и отправлена на обработку

### Просмотр результатов

1. После загрузки фотография появится в сетке фотографий
2. Кликните на фотографию, чтобы открыть ее в модальном окне
3. Если обработка завершена, вы увидите:
   - Географические координаты здания
   - Адрес здания
   - Результаты OCR (если есть)
   - Информацию о распознанных зданиях

## Разработка и настройка

### Структура проекта

```
├── full-stack/                 # Микросервисы приложения
│   ├── AuthService/           # Сервис аутентификации
│   ├── DB/                    # Конфигурация базы данных
│   ├── PhotoUploadService/    # Сервис загрузки фотографий
│   ├── ngnix/                 # Веб-сервер и фронтенд
│   └── docker-compose.yml     # Конфигурация Docker Compose
├── src/                       # Основной код приложения
│   ├── api/                   # API сервис обработки изображений
│   ├── data/                  # Работа с данными
│   ├── geo/                   # Геокодирование
│   ├── models/                # Модели компьютерного зрения
│   ├── tasks/                 # Асинхронные задачи Celery
│   └── utils/                 # Вспомогательные функции
├── data/                      # Данные и индексы
├── configs/                   # Конфигурационные файлы
└── notebooks/                 # Jupyter ноутбуки для анализа
```

### Добавление новых изображений в базу данных

Для добавления новых изображений в базу данных для поиска:

1. Загрузите изображения в облачное хранилище
2. Убедитесь, что у изображений есть метаданные с координатами
3. Запустите скрипт построения базы данных:
   ```bash
   python src/data/database_builder.py
   ```

### Настройка модели

Конфигурация модели находится в файле `src/utils/config.py`:

```python
# Настройки модели
MODEL_CONFIG = {"model_name": "ResNet50", "input_size": (224, 224), "pooling": "avg"}

# Настройки FAISS
FAISS_CONFIG = {"index_type": "IVF2048,Flat", "nlist": 2048, "metric": "l2"}
```

## API Endpoints

### Auth Service
- `POST /api/register` - регистрация пользователя
- `POST /api/login` - вход пользователя
- `GET /api/auth` - проверка аутентификации

### Photo Upload Service
- `POST /api/photo_upload` - загрузка фотографии
- `GET /api/photos` - получение списка фотографий пользователя

### Main Application Service
- `POST /process_image` - синхронная обработка изображения
- `POST /process_image_async` - асинхронная обработка изображения
- `GET /task/{task_id}` - получение статуса задачи
- `GET /results/latest` - получение последних результатов обработки
- `POST /search/by_coordinates` - поиск изображений по координатам
- `POST /search/by_address` - поиск изображений по адресу
- `GET /export/results/xlsx` - экспорт результатов обработки в формате XLSX

## Troubleshooting

### Проблемы с подключением к базе данных

Убедитесь, что:
1. Все переменные окружения заданы правильно
2. Сервис базы данных запущен
3. Правильно указаны учетные данные

### Проблемы с обработкой изображений

Если изображения не обрабатываются:
1. Проверьте логи сервиса обработки изображений
2. Убедитесь, что Redis доступен
3. Проверьте наличие индекса FAISS в директории `data/index/`

## Лицензия

MIT License

## Контакты

Для вопросов и поддержки обращайтесь к команде разработчиков.
